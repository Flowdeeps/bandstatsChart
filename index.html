<!DOCTYPE html>
<html>
<head>
  <title>Band by region</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="css/normalize.css" type="text/css" />
  <link rel="stylesheet" href="css/charts.css" type="text/css" />

  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script type="text/javascript" src="js/charts.js"></script>

</head>
<body class="citycharts">
  <div>
    <form class="band-list">
      <fieldset id="city">
        <label>Scene</label>
        <select id='bsc-scene-select'>
        </select>
      </fieldset>
      <fieldset id="show">
        <label>Show</label>
        <select>
          <option>All Artists</option>
          <option>Stared Artists</option>
        </select>
      </fieldset>
      <fieldset id="sort">
        <label>Order by</label>
        <select id="bsc-orderby-select">
          <option value="bandScore">Web Buzz</option>
          <option value="lastFMListenersIncr">Popularity</option>
          <option value="bandMyspaceProfileViews">Facebook Likes</option>
          <option value= "lastFMListeners">Last.FM Fans</option>
        </select>
      </fieldset>
      <fieldset id="limit">
        <label>Limit</label>
        <select id="bsc-limit-select">
          <option value="20">20</option>
          <option value="40">40</option>
          <option value="60">60</option>
        </select>
      </fieldset>
    
    <ul>
      <li><a href="#" id="bsc-prev" class="prev">Previous</a></li>
      <li><a href="#" id="bsc-next" class="next">Next</a></li>
    </ul>
    </form>

    <section>
      <div class="genres">
        <h3>Genre(s)</h3>
        <ul id='bsc-genre-list'>
        </ul>
      </div>

      <ol id="bsc-chart" class="chart">
      </ol>
    </section>

    <aside>
        <div>
            <h3 id='bsc-login-status'><a id='bsc-login-btn' href='#'>login</a></h3>
        </div>
        <div>
            <ul id='bsc-genre-select'>
            </ul>
        </div>
    </aside>
  </div>
</body>

<script type="text/javascript">
    bandstatsChart.init(function() {

        bandstatsChart.getAllRegions();
        bandstatsChart.getAllGenres();
        bandstatsChart.getChart('','','',20);
    });

    // facebook stuff
    window.fbAsyncInit = function() {
        FB.init({
            //appId      : '115928858587081',
            appId      : '204182706372946',
            channelUrl : '//www.thedelimagazine.com/bandstats/channel.html', 
            status     : true,
            cookie     : true, 
            xfbml      : true 
        });

        // Additional init code here
        FB.getLoginStatus(function(response) {
            if (response.status === 'connected') {
                // connected
                FB.api('/me', function(response) {
                    console.log(response);
                    $('#bsc-login-status').html('hey, ' + response.name);
                    bandstatsChart.setFacebookId(response.id);
                });
            } else if (response.status === 'not_authorized') {
                // not_authorized
                login();
            } else {
                // not_logged_in
                login();
            }
        });
    };

    function login() {
        FB.login(function(response) {
            if (response.authResponse) {
                // connected
                FB.api('/me', function(response) {
                    $('#bsc-login-status').html('hey, ' + response.name);
                    bandstatsChart.setFacebookId(response.id);
                });
            } else {
                // cancelled
                console.log('error loggin in: '+response);
            }
        });
    };

    $('#bsc-login-btn').click(function() {
        login();
    });

    // Load the Facebook SDK Asynchronously
    (function(d){
        var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
        if (d.getElementById(id)) {return;}
            js = d.createElement('script'); js.id = id; js.async = true;
            js.src = "//connect.facebook.net/en_US/all.js";
            ref.parentNode.insertBefore(js, ref);
    }(document));
   
// rating bs
$(document).ready(function() { 
    $('.rate_widget').each(function(i) {
        var widget = this;
        var out_data = {
            band_id : $(widget).attr('id')
        };
        /*  
        $.post(
            '/rating/show',
            out_data,
            function(INFO) {
                $(widget).data( 'fsr', INFO );
                set_votes(widget);
            },
            'json'
        );
        */
    });


    $('.ratings_stars').hover(
        // Handles the mouseover
        function() {
            $(this).prevAll().andSelf().addClass('ratings_over');
            $(this).nextAll().removeClass('ratings_vote'); 
        },
        // Handles the mouseout
        function() {
            $(this).prevAll().andSelf().removeClass('ratings_over');
            // can't use 'this' because it wont contain the updated data
            set_votes($(this).closest('.rate_widget'));
        }
    );
    
    
    // This actually records the vote
    $('.ratings_stars').bind('click', function() {
        var star = this;
        var widget = $(this).closest('.rate_widget');
        var score = $(star).attr('class').match(/star_(\d+)/)[1];
 
        var clicked_data = {
            f_rating_score : score,
            f_article_number : widget.attr('id')
        };
        /*
        $.post(
            '/rating/save',
            clicked_data,
            function(INFO) {
                widget.data( 'fsr', INFO );
                set_votes(widget);
            },
            'json'
        );
        */ 
    });
});

function set_votes(widget) {
    if ($(widget).data('fsr')) {
        var avg = $(widget).data('fsr').whole_avg;
        var votes = $(widget).data('fsr').number_votes;
        var exact = $(widget).data('fsr').dec_avg;
        var error = $(widget).data('fsr').error;

        $(widget).find('.star_' + avg).prevAll().andSelf().addClass('ratings_vote');
        $(widget).find('.star_' + avg).nextAll().removeClass('ratings_vote'); 
    }
}
</script>
</html>
