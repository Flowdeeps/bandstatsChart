<!DOCTYPE html>
<html>
<head>
  <title>Band by region</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="css/normalize.css" type="text/css" />
  <link rel="stylesheet" href="css/charts.css" type="text/css" />

  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script type="text/javascript" src="js/charts.js"></script>

</head>
<body class="citycharts">
  <div>
    <form class="band-list">
      <fieldset id="city">
        <label>Scene</label>
        <select id='bsc-scene-select'>
        </select>
      </fieldset>
      <fieldset id="show">
        <label>Show</label>
        <select>
          <option>All Artists</option>
          <option>Stared Artists</option>
        </select>
      </fieldset>
      <fieldset id="sort">
        <label>Order by</label>
        <select id="bsc-orderby-select">
          <option value="bandScore">Web Buzz</option>
          <option value="lastFMListenersIncr">Popularity</option>
          <option value="bandMyspaceProfileViews">Facebook Likes</option>
          <option value= "lastFMListeners">Last.FM Fans</option>
        </select>
      </fieldset>
    <!-- leaving out for now
      <fieldset id="limit">
        <label>Limit</label>
        <select id="bsc-limit-select">
          <option value="20">20</option>
          <option value="40">40</option>
          <option value="60">60</option>
        </select>
      </fieldset>
    --> 
      <button id="bsc-prev" class="prev">&lt;</button>
      <button id="bsc-next" class="next">&gt;</button>
    </form>

    <section>
      <div class="genres">
        <h3>Genre(s)</h3>
        <ul id='bsc-genre-list'>
        </ul>
      </div>

      <ol id="bsc-chart" class="chart">
      </ol>
    </section>

    <aside>
        <div>
            <h3 id='bsc-login-status'><a id='bsc-login-btn' href='#'>login</a></h3>
        </div>
        <div>
            <ul id='bsc-genre-select'>
            </ul>
        </div>
    </aside>
  </div>
</body>

<script type="text/javascript">
    bandstatsChart.init(function() {

        bandstatsChart.getAllRegions();
        bandstatsChart.getAllGenres();
        bandstatsChart.getChart('','','',20);
    });

    // facebook stuff
    window.fbAsyncInit = function() {
        FB.init({
            //appId      : '115928858587081',
            appId      : '204182706372946',
            channelUrl : '//www.thedelimagazine.com/bandstats/channel.html', 
            status     : true,
            cookie     : true, 
            xfbml      : true 
        });

        // Additional init code here
        FB.getLoginStatus(function(response) {
            if (response.status === 'connected') {
                // connected
                FB.api('/me', function(response) {
                    console.log(response);
                    $('#bsc-login-status').html('hey, ' + response.name);
                    bandstatsChart.setFacebookId(response.id);
                    applyUserPrefs();
                });
            } else if (response.status === 'not_authorized') {
                // not_authorized
                login();
            } else {
                // not_logged_in
                login();
            }
        });
    };

    function applyUserPrefs() {
        $.ajax({
            url: '../api/prefs.php',
            type: 'get',
            dataType: 'json',
            success: function(response) {
                console.log(response);
                if (response['genre-list']) {
                    var genrePrefs = response['genre-list'].split(',');
                    for (var g in genrePrefs) {
                        var genre = genrePrefs[g];
                        bandstatsChart.addGenre(genre);
                    } 
                } 
            },
            error: function() {
                console.log('could not get prefs');
            }
        }); 
 
    };

    function login() {
        FB.login(function(response) {
            if (response.authResponse) {
                // connected
                FB.api('/me', function(response) {
                    $('#bsc-login-status').html('hey, ' + response.name);
                    bandstatsChart.setFacebookId(response.id);
                });
            } else {
                // cancelled
                console.log('error loggin in: '+response);
            }
        });
    };

    $('#bsc-login-btn').click(function() {
        login();
    });

    // Load the Facebook SDK Asynchronously
    (function(d){
        var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
        if (d.getElementById(id)) {return;}
            js = d.createElement('script'); js.id = id; js.async = true;
            js.src = "//connect.facebook.net/en_US/all.js";
            ref.parentNode.insertBefore(js, ref);
    }(document));
   
</script>
</html>
